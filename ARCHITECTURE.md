# Архитектура аутрича на 1200 email-адресов

## Компоненты
- DNS: Cloudflare (MX/SPF/DKIM/DMARC, бесплатный план, health-check MX).
- SMTP/отправка: основной — Amazon SES (дешево, высокая доставляемость), резерв — Mailgun/Postmark (евро/US зоны), переключение по SLA/квоте.
- Хранилище: управляемый Postgres (RDS/Neon) для кампаний, логов отправок, статусов.
- Очередь заданий: SQS/RabbitMQ/Redis-queues для расстановки отправок и ретраев.
- Оркестратор: легкий сервис/воркер (Python/FastAPI + Celery/RQ) для планирования, темплейтов, трекинга opens/clicks (через трекинг-домен).
- Прием ответов: IMAP-агент (например, imapclient + webhook) или API провайдера (Postmark inbound) с разбором и записью в БД.
- Наблюдение: Prometheus/Grafana или managed (CloudWatch), алерты в Telegram/Slack; Sentry для ошибок кода.

## Ротация и лимиты
- Пулы доменов (8–12 доменов) и ящиков (по 3–5 адресов на домен) → 1200 адресов распределяются по клиентам/направлениям.
- Суточные лимиты на ящик: 30–50 исходящих, интервалы 2–5 мин, отправка в рабочие часы целевых зон.
- Карусель доменов: round-robin по доменам и ящикам, с backoff при росте bounce/complaints.
- Прогрев новых доменов/ящиков: отдельная очередь с мягкими лимитами и авто-повышением при хорошей доставляемости.

## Мониторинг
- Метрики: доставка/opens/clicks, bounce rate, жалобы, время ответа SMTP, длина очередей, ошибки DKIM/SPF.
- Пробы DNS/MX и HTTP health-check воркеров; алерт при превышении bounce > 3–5% или росте soft bounces.
- Логи: централизованный сбор (CloudWatch/ELK) + корреляция с доменом/ящиком/кампанией.

## Распределение нагрузки
- Планировщик пишет задания в очередь с учетом лимитов домена/ящика.
- Воркеры читают из очереди, выбирая доступный отправитель (respect к лимиту и времени простоя).
- При недоступности основного SMTP переключение на резервный провайдер или соседний домен из пула.
- Трекинг-домены разнесены по зонам (EU/US) для снижения задержек и блокировок.

## Риски и смягчение
- Блокировки/спам: строгий SPF/DKIM/DMARC, уникальные трекинг-домены, умеренные лимиты, постепенный прогрев.
- Квоты провайдеров: мониторинг остатка SES/Mailgun, авто-переключение на резерв.
- Одновременный отказ зоны: дублирование воркеров в двух регионах, резервный SMTP и резервные DNS (Cloudflare + secondary NS).
- Утечки токенов: хранение секретов в Secret Manager/SSM, минимальные IAM роли.

## Оценка стоимости (в мес, грубо)
- Домен: ~$10/год → ~$1/мес на домен; 10 доменов ≈ $10.
- SES: $0.10 за 1k писем; при 30 писем * 1200 ящиков * 22 рабочих дня ≈ 792k писем → ~$79 (частично можно снизить лимитами/неиспользуемыми ящиками).
- Резервный SMTP (Mailgun Foundation): ~$35.
- Postgres (минимальный managed): $15–30.
- Воркеры/приложение (2×small контейнера на Fly.io/Render): $10–20.
- Мониторинг (CloudWatch basic / Grafana Cloud free tier): ~$0–10.
- Итого ориентир: $150–180/мес при умеренных лимитах; снижается при меньших объемах отправок.

## Тесты
- Локальные юнит-тесты (`pytest`, 6 тестов) проверяют:
  - статусы MX-проверки (валидный/нет MX/нет домена),
  - обрезку сообщения до лимита Telegram,
  - успешную/ошибочную отправку,
  - загрузку настроек из окружения и `.env`.

## Структура проекта
- `mailtools/` — бизнес-логика (MX-проверка, отправка Telegram, настройки, константы).
- `scripts/` — CLI-обёртки для запуска задач.
- `tests/` — pytest-юниты.

